<script type="text/javascript">

    var msStructure = null;

    function getStructureFile(callback) {

        //TODO: check if miniserver is connected/available
        //TODO: add spinner while loading miniserver structure
        var configNodeId = $('#node-input-miniserver').val();
        var url = './struct?id=' + configNodeId;

        $('#return-msg').text('');

        if (configNodeId) {

            $.getJSON(url)
                .done(function (data) {

                    //console.log(data);

                    if (data.state == 'ok') {

                        var uuid;
                        var $roomSelect = $('#node-input-room');
                        var $categorySelect = $('#node-input-category');
                        var $controlSelect = $('#node-input-control');

                        $roomSelect.empty();
                        $categorySelect.empty();
                        $controlSelect.empty();

                        $roomSelect.append('<option value=""></option>');
                        for (uuid in data.structure.rooms) {
                            if (data.structure.rooms.hasOwnProperty(uuid)) {
                                $roomSelect.append('<option value="' + uuid + '">' + data.structure.rooms[uuid].name + '</option>');
                            }
                        }

                        $categorySelect.append('<option value=""></option>');
                        for (uuid in data.structure.cats) {
                            if (data.structure.cats.hasOwnProperty(uuid)) {
                                $categorySelect.append('<option value="' + uuid + '">' + data.structure.cats[uuid].name + '</option>');
                            }
                        }

                        $controlSelect.append('<option value=""></option>');
                        for (uuid in data.structure.controls) {
                            if (data.structure.controls.hasOwnProperty(uuid)) {
                                var $option = $('<option value="' + uuid + '">' +
                                    (data.structure.controls[uuid].parent ? ' └─ ' : '') +
                                    data.structure.controls[uuid].name +
                                    '</option>');
                                $option.appendTo($controlSelect);
                            }
                        }

                    } else {
                        $('#return-msg').text(data.msg);
                    }

                    callback(data);

                });
        } else {
            $('#return-msg').text('No miniserver selected or connected!');
        }

    }

    function fillControl(e) {

        //TODO: Show "detail" from structure if present

        var $roomSelect = $('#node-input-room');
        var $categorySelect = $('#node-input-category');
        var $controlSelect = $('#node-input-control');
        var $stateSelect = $('#node-input-state');
        $controlSelect.off('change');

        var roomVal = $roomSelect.val();
        var categoryVal = $categorySelect.val();
        var oldControl = $controlSelect.val();

        $controlSelect.empty();

        //leave options that match if already present
        var options = [];
        for (var uuid in msStructure.controls) {
            if (
                msStructure.controls.hasOwnProperty(uuid) &&
                ((roomVal.length && msStructure.controls[uuid].room == roomVal) || !roomVal.length) &&
                ((categoryVal.length && msStructure.controls[uuid].cat == categoryVal) || !categoryVal.length)
            ) {
                options.push('<option value="' + uuid + '">' +
                    (msStructure.controls[uuid].parent ? ' └─ ' : '') +
                    msStructure.controls[uuid].name +
                    '</option>'
                );
            }
        }

        if (options.length > 1) {
            $controlSelect.append('<option value=""></option>');
        }
        $controlSelect.append(options.join(''));

        if ($controlSelect.find('option[value="' + oldControl + '"]').length) {
            $controlSelect.val(oldControl);
        } else {
            $stateSelect.empty();
        }


        $controlSelect.on('change', fillState);
        if (options.length == 1) {
            $controlSelect.trigger('change');
        }

    }

    function fillState(e) {

        var $stateSelect = $('#node-input-state');
        $stateSelect.empty();
        $stateSelect.append('<option value=""></option>');

        if (typeof msStructure.controls[this.value] != 'undefined') {

            var control = msStructure.controls[this.value];

            for (var statename in control.states) {
                if (control.states.hasOwnProperty(statename)) {
                    $stateSelect.append(
                        '<option value="' + control.states[statename] + '">' +
                        statename +
                        '</option>');
                }
            }

        }

    }


    function disableChangeEvents() {
        $('#node-input-miniserver, #node-input-room, #node-input-category, #node-input-control').off('change');
    }
</script>

<script type="text/x-red" data-help-name="loxone-in">
    <p>
        This node attaches to a control on the selected Miniserver and will receive every event
        when it occurs and on connecting.<br>
        The controls will be loaded automaticaly from the connected Miniserver.<br>
        <br>
        Choose the wanted <code>state</code> from the dropdown. The value received
        will be in <code>msg.payload</code><br>
        <br>
        Here's an example of the complete <code>msg</code>-object:
        <pre>{
    payload: 20.8125,
    topic: "test ds18b20",
    state: "value",
    room: "Serverraum",
    category: "Temperatur",
    details: {
        format: "%.1f°"
    },
    type: "InfoOnlyAnalog"
}</pre>
        <br>
        The documentation of every element can be found in
        <a href="https://www.loxone.com/dede/wp-content/uploads/sites/2/2016/08/loxone-structure-file.pdf?x48792" target="_blank">
            Loxones Structure File
        </a>.
    </p>

</script>

<script type="text/x-red" data-template-name="loxone-in">

    <div class="form-row">
        <label for="node-input-miniserver">
            <i class="fa fa-globe"></i>
            Miniserver
        </label>
        <input type="text" id="node-input-miniserver">
    </div>

    <div class="form-row">
        <label for="node-input-room">
            <i class="icon-home"></i>
            Room
        </label>
        <select id="node-input-room">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-category">
            <i class="icon-list"></i>
            Category
        </label>
        <select id="node-input-category">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-control">
            <i class="fa fa-cogs"></i>
            Control
        </label>
        <select id="node-input-control">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-state">
            <i class="fa fa-sticky-note-o" ></i>
            State
        </label>
        <select id="node-input-state">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <span id="return-msg"></span>
    </div>


</script>

<script type="text/javascript">
    RED.nodes.registerType('loxone-in', {
        category: 'input',
        color: '#83B817',
        defaults: {
            name: {value: ''},
            miniserver: {type: 'loxone-miniserver', required: true},
            control: {value: '', required: true},
            state: {value: '', required: true}
        },
        inputs: 0,
        outputs: 1,
        icon: "loxone.png",
        label: function () {
            return this.name || "loxone";
        },
        oneditprepare: function () {
            var node = this;

            function prepareInput() {
                disableChangeEvents();
                $('#node-input-miniserver').on('change', prepareInput);

                getStructureFile(function (data) {

                    msStructure = data.structure;

                    var $controlSelect = $('#node-input-control');
                    $controlSelect.on('change', fillState);
                    $('#node-input-room, #node-input-category').on('change', fillControl);

                    if (node.control) {
                        $controlSelect.val(node.control);
                        $controlSelect.trigger('change');

                        //select proper room and categoriy for selected control
                        var controlFromStructure = data.structure.controls[node.control];
                        $('#node-input-room').val(controlFromStructure.room);
                        $('#node-input-category').val(controlFromStructure.cat);

                        if (node.state) {
                            $('#node-input-state').val(node.state);
                        }
                    }


                });
            };

            prepareInput();
        },
        oneditsave: function () {
            disableChangeEvents();
        },
        oneditcancel: function () {
            disableChangeEvents();
        }
    });
</script>


<script type="text/x-red" data-help-name="loxone-out">
    <p>
        Select the control where <code>msg.payload</code> will be send to.<br>
        <br>
        <b>Note:</b> Keep in mind, that you have to submit valid data to the Miniserver
        Control as described in the Structure File Documentation.
    </p>

</script>


<script type="text/x-red" data-template-name="loxone-out">

    <div class="form-row">
        <label for="node-input-miniserver">
            <i class="fa fa-globe"></i>
            Miniserver
        </label>
        <input type="text" id="node-input-miniserver">
    </div>

    <div class="form-row">
        <label for="node-input-room">
            <i class="icon-home"></i>
            Room
        </label>
        <select id="node-input-room">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-category">
            <i class="icon-list"></i>
            Category
        </label>
        <select id="node-input-category">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-control">
            <i class="icon-cogs"></i>
            Control
        </label>
        <select id="node-input-control">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <span id="return-msg"></span>
    </div>

</script>

<script type="text/javascript">
    RED.nodes.registerType('loxone-out', {
        category: 'output',
        color: '#83B817',
        defaults: {
            name: {value: ''},
            miniserver: {type: 'loxone-miniserver', required: true},
            control: {value: '', required: true}
        },
        inputs: 1,
        outputs: 0,
        icon: "loxone.png",
        align: "right",
        label: function () {
            return this.name || "loxone";
        },
        oneditprepare: function () {
            var node = this;

            function prepareInput() {
                disableChangeEvents();
                $('#node-input-miniserver').on('change', prepareInput);

                getStructureFile(function (data) {
                    msStructure = data.structure;

                    $('#node-input-room, #node-input-category').on('change', fillControl);

                    var $controlSelect = $('#node-input-control');

                    if (node.control) {
                        $controlSelect.val(node.control);

                        //select proper room and category for selected control
                        var controlFromStructure = data.structure.controls[node.control];
                        $('#node-input-room').val(controlFromStructure.room);
                        $('#node-input-category').val(controlFromStructure.cat);
                    }


                });
            };

            prepareInput();
        },
        oneditsave: function () {
            disableChangeEvents();
        },
        oneditcancel: function () {
            disableChangeEvents();
        }
    });
</script>



<script type="text/x-red" data-help-name="loxone-miniserver">
    <p>
        Configure the Miniserver to connect to, the default port is 80. The credentials will be hashed with a key given by the Miniserver.<br>
        <br>
        A websocket connection will be made and kept alive. All communication with the Miniserver will be handled
        over this connection as described in Loxones <a href="https://www.loxone.com/dede/wp-content/uploads/sites/2/2016/08/loxone-communicating-with-the-miniserver.pdf" target="_blank">
        Websocket API</a>.<br>
        The structure of your Miniserver will be loaded on connecting an is selectable on adding an in- or out-node.
        <br>
        <br>
        If you want, enable AES-256-CBC encryption and the commands/values get encrypted. Otherwise only hashing of the commands is done.<br>
        <br>
        <b>The miniserver is not capable to do full SSL-Encryption of the connection.</b><br>
        For further details, see the API-documentation.
    </p>

</script>


<script type="text/x-red" data-template-name="loxone-miniserver">

    <div class="form-row node-input-broker">
        <label for="node-config-input-broker">
            <i class="fa fa-globe"></i> Miniserver
        </label>
        <input class="input-append-left" type="text" id="node-config-input-host" placeholder="hostname/ip" style="width: 40%;" >

        <label for="node-config-input-port" style="margin-left: 10px; width: 35px;">
            Port
        </label>
        <input type="text" id="node-config-input-port" style="width:45px" placeholder="80">
    </div>

    <div class="form-row">
        <label for="node-config-input-username"><i class="fa fa-user"></i> User</label>
        <input type="text" id="node-config-input-username">
    </div>
    <div class="form-row">
        <label for="node-config-input-password"><i class="fa fa-lock"></i> Password</label>
        <input type="password" id="node-config-input-password">
    </div>
    <div class="form-row">
        <label></label>
        <input type="checkbox" id="node-config-input-encrypted" style="display:inline-block; width:auto; vertical-align:top;">
        <label style="width: 70%;" for="node-config-input-encrypted">
            Use AES Encryption?
        </label>
    </div>

</script>

<script type="text/javascript">
    RED.nodes.registerType('loxone-miniserver', {
        category: 'config',
        defaults: {
            host: {value: "", required: true},
            port: {value: 80, required: true, validate: RED.validators.number()},
            encrypted: {value: false}
        },
        credentials: {
            username: {type: "text", required: true},
            password: {type: "password", required: true}
        },
        label: function () {
            return this.host;
        },
        oneditsave: function () {
            this.encrypted = $('#node-config-input-encrypted').prop('checked');
        }
    });
</script>


