<script type="text/javascript">

    var msStructure = null;

    function getStructureFile(callback) {

        //TODO: check if miniserver is connected/available
        //TODO: add spinner while loading miniserver structure
        var configNodeId = $('#node-input-miniserver').val();
        var url = './struct?id=' + configNodeId;

        $('#return-msg').text('');

        if (configNodeId) {

            $.getJSON(url)
                .done(function (data) {

                    //console.log(data);

                    if (data.state == 'ok') {

                        var uuid;
                        var $roomSelect = $('#node-input-room');
                        var $categorySelect = $('#node-input-category');
                        var $controlSelect = $('#node-input-control');

                        $roomSelect.empty();
                        $categorySelect.empty();
                        $controlSelect.empty();

                        $roomSelect.append('<option value=""></option>');
                        for (uuid in data.structure.rooms) {
                            if (data.structure.rooms.hasOwnProperty(uuid)) {
                                $roomSelect.append('<option value="' + uuid + '">' + data.structure.rooms[uuid].name + '</option>');
                            }
                        }

                        $categorySelect.append('<option value=""></option>');
                        for (uuid in data.structure.cats) {
                            if (data.structure.cats.hasOwnProperty(uuid)) {
                                $categorySelect.append('<option value="' + uuid + '">' + data.structure.cats[uuid].name + '</option>');
                            }
                        }

                        $controlSelect.append('<option value=""></option>');
                        for (uuid in data.structure.controls) {
                            if (data.structure.controls.hasOwnProperty(uuid)) {
                                var $option = $('<option value="' + uuid + '">' +
                                    (data.structure.controls[uuid].parent ? ' └── ' : '') +
                                    data.structure.controls[uuid].name +
                                    '</option>');
                                $option.appendTo($controlSelect);
                            }
                        }

                    } else {
                        $('#return-msg').text(data.msg);
                    }

                    callback(data);

                });
        } else {
            $('#return-msg').text('No miniserver selected or connected!');
        }

    }

    function fillControl(e) {

        //TODO: Show "detail" from structure if present

        var $roomSelect = $('#node-input-room');
        var $categorySelect = $('#node-input-category');
        var $controlSelect = $('#node-input-control');
        var $stateSelect = $('#node-input-state');
        $controlSelect.off('change');

        var roomVal = $roomSelect.val();
        var categoryVal = $categorySelect.val();
        var oldControl = $controlSelect.val();

        $controlSelect.empty();

        //leave options that match if already present
        var options = [];
        for (var uuid in msStructure.controls) {
            if (
                msStructure.controls.hasOwnProperty(uuid) &&
                ((roomVal.length && msStructure.controls[uuid].room == roomVal) || !roomVal.length) &&
                ((categoryVal.length && msStructure.controls[uuid].cat == categoryVal) || !categoryVal.length)
            ) {
                options.push('<option value="' + uuid + '">' +
                    (msStructure.controls[uuid].parent ? ' └── ' : '') +
                    msStructure.controls[uuid].name +
                    '</option>'
                );
            }
        }

        if (options.length > 1) {
            $controlSelect.append('<option value=""></option>');
        }
        $controlSelect.append(options.join(''));

        if($controlSelect.find('option[value="' + oldControl + '"]').length){
            $controlSelect.val(oldControl);
        } else {
            $stateSelect.empty();
        }



        $controlSelect.on('change', fillState);
        if (options.length == 1) {
            $controlSelect.trigger('change');
        }

    }

    function fillState(e) {

        var $stateSelect = $('#node-input-state');
        $stateSelect.empty();
        $stateSelect.append('<option value=""></option>');

        if (typeof msStructure.controls[this.value] != 'undefined') {

            var control = msStructure.controls[this.value];

            for (var statename in control.states) {
                if (control.states.hasOwnProperty(statename)) {
                    $stateSelect.append(
                        '<option value="' + control.states[statename] + '">' +
                        statename +
                        '</option>');
                }
            }

        }

    }


    function disableChangeEvents() {
        $('#node-input-room, #node-input-category, #node-input-control').off('change');
    }
</script>

<script type="text/x-red" data-help-name="loxone-in">
    <p>bla bla</p>













</script>

<script type="text/x-red" data-template-name="loxone-in">

    <div class="form-row">
        <label for="node-input-miniserver">
            <i class="fa fa-globe"></i>
            Miniserver
        </label>
        <input type="text" id="node-input-miniserver">
    </div>

    <div class="form-row">
        <label for="node-input-room">
            <i class="icon-home"></i>
            Room
        </label>
        <select id="node-input-room">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-category">
            <i class="icon-list"></i>
            Category
        </label>
        <select id="node-input-category">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-control">
            <i class="fa fa-cogs"></i>
            Control
        </label>
        <select id="node-input-control">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-state">
            <i class="fa fa-sticky-note-o" ></i>
            State
        </label>
        <select id="node-input-state">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <span id="return-msg"></span>
    </div>













</script>

<script type="text/javascript">
    RED.nodes.registerType('loxone-in', {
        category: 'input',
        color: '#83B817',
        defaults: {
            name: {value: ''},
            miniserver: {type: 'loxone-miniserver', required: true},
            control: {value: '', required: true},
            state: {value: '', required: true}
        },
        inputs: 0,
        outputs: 1,
        icon: "loxone.png",
        label: function () {
            return this.name || "loxone";
        },
        oneditprepare: function () {

            var node = this;

            getStructureFile(function (data) {

                msStructure = data.structure;

                var $controlSelect = $('#node-input-control');
                $controlSelect.on('change', fillState);
                $('#node-input-room, #node-input-category').on('change', fillControl);

                if (node.control) {
                    $controlSelect.val(node.control);
                    $controlSelect.trigger('change');

                    //select proper room and categoriy for selected control
                    var controlFromStructure = data.structure.controls[node.control];
                    $('#node-input-room').val(controlFromStructure.room);
                    $('#node-input-category').val(controlFromStructure.cat);

                    if (node.state) {
                        $('#node-input-state').val(node.state);
                    }
                }



            });
        },
        oneditsave: function () {
            disableChangeEvents();
        },
        oneditcancel: function () {
            disableChangeEvents();
        }
    });
</script>


<script type="text/x-red" data-template-name="loxone-out">

    <div class="form-row">
        <label for="node-input-miniserver">
            <i class="fa fa-globe"></i>
            Miniserver
        </label>
        <input type="text" id="node-input-miniserver">
    </div>

    <div class="form-row">
        <label for="node-input-room">
            <i class="icon-home"></i>
            Room
        </label>
        <select id="node-input-room">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-category">
            <i class="icon-list"></i>
            Category
        </label>
        <select id="node-input-category">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-control">
            <i class="icon-cogs"></i>
            Control
        </label>
        <select id="node-input-control">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <span id="return-msg"></span>
    </div>







</script>

<script type="text/javascript">
    RED.nodes.registerType('loxone-out', {
        category: 'output',
        color: '#83B817',
        defaults: {
            name: {value: ''},
            miniserver: {type: 'loxone-miniserver', required: true},
            control: {value: '', required: true},
        },
        inputs: 1,
        outputs: 0,
        icon: "loxone.png",
        align: "right",
        label: function () {
            return this.name || "loxone";
        },
        oneditprepare: function () {

            var node = this;

            getStructureFile(function (data) {
                msStructure = data.structure;

                $('#node-input-room, #node-input-category').on('change', fillControl);

                var $controlSelect = $('#node-input-control');

                if (node.control) {
                    $controlSelect.val(node.control);

                    //select proper room and categoriy for selected control
                    var controlFromStructure = data.structure.controls[node.control];
                    $('#node-input-room').val(controlFromStructure.room);
                    $('#node-input-category').val(controlFromStructure.cat);
                }


            });

        },
        oneditsave: function () {
            disableChangeEvents();
        },
        oneditcancel: function () {
            disableChangeEvents();
        }
    });
</script>


<script type="text/x-red" data-template-name="loxone-miniserver">

    <div class="form-row node-input-broker">
        <label for="node-config-input-broker">
            <i class="fa fa-globe"></i> Miniserver
        </label>
        <input class="input-append-left" type="text" id="node-config-input-host" placeholder="hostname/ip" style="width: 40%;" >

        <label for="node-config-input-port" style="margin-left: 10px; width: 35px;">
            Port
        </label>
        <input type="text" id="node-config-input-port" style="width:45px" placeholder="80">
    </div>

    <div class="form-row">
        <label for="node-config-input-username"><i class="fa fa-user"></i> User</label>
        <input type="text" id="node-config-input-username">
    </div>
    <div class="form-row">
        <label for="node-config-input-port"><i class="fa fa-lock"></i> Password</label>
        <input type="password" id="node-config-input-password">
    </div>













</script>

<script type="text/javascript">
    RED.nodes.registerType('loxone-miniserver', {
        category: 'config',
        defaults: {
            host: {value: "", required: true},
            port: {value: 80, required: true, validate: RED.validators.number()},
        },
        credentials: {
            username: {type: "text", required: true},
            password: {type: "password", required: true}
        },
        label: function () {
            return this.host;
        }
    });
</script>


